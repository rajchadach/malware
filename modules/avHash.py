import json
import requests
import pandas as pd
import time


def getAVLabel():
    key = "4d136db14d01764a950e9fd365693ba19cc99f486720f5e01e786cb5c57fb554"
    label = ""
    #key = "7fd75d2522495cf32767074c53935d1663ca91f9a86c18c2ea414c92e20d3e5b"
    df_hash = pd.read_csv("static_New1.csv")
    hash_list = df_hash["SHA256"].tolist()
    for hash in hash_list:
        params = {'apikey': key, 'resource': str(hash)}
        with open("label_virustotal.txt", "a") as fileWrite2:
            report = requests.get("https://www.virustotal.com/vtapi/v2/file/report", params=params)
            json_response = report.json()
            response = int(json_response['response_code'])
            if response == 0:
                label = "Not in Virus Total"
            elif response == 1:
                positives = int(json_response['positives'])
                if positives == 0 or positives == 1:
                    label = "Benign"
                else:
                    label = "Malicious"
            else:
                print(' could not be searched. Please try again later.')
            fileWrite2.write('%s:%s\n' % (hash, label))
            time.sleep(20)

    labelList = {}
    with open("label_virustotal.txt", 'r') as labelRead:
        for line in labelRead:
            key, val = line.strip().split(":")
            labelList[key] = val
    df_hash["Label_Virus"] = df_hash['SHA256'].map(labelList)
    df_hash.to_csv('static_New1.csv', index=False)




