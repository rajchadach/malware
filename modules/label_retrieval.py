import json
import requests
import pandas as pd
import time
import avHash
import os
import sys
from google.colab import drive
import pandas as pd
drive.mount('/content/gdrive')

def getAVLabel():
    key = "4d136db14d01764a950e9fd365693ba19cc99f486720f5e01e786cb5c57fb554"
    label = ""
    df_hash = pd.read_csv("static.csv")
    file_list = df_hash["Filename"].tolist()
    hash_list = df_hash["SHA256"].tolist()
    hash_file = list (map (  lambda x,y: [x,y], hash_list,file_list    ))

    for hash in hash_file:
        params = {'apikey': key, 'resource': str(hash[0])}
        with open("label_virustotal.txt", "a") as fileWrite2:
            report = requests.get("https://www.virustotal.com/vtapi/v2/file/report", params=params)
            json_response = report.json()
            response = int(json_response['response_code'])
            if response == 0:
                try:
                  size_in_bytes = os.path.getsize(os.path.join("/content/gdrive/My Drive/NNN1", str(hash[1])))
                  if size_in_bytes/(1024*1024) <= 550:
                    binary_file = {'file': (file, open(os.path.join("/content/gdrive/My Drive/NNN1", str(hash[1])), "rb"))}
                    response = requests.post("https://www.virustotal.com/vtapi/v2/file/scan", files=binary_file, params={'apikey': key})
                    json_response = response.json()
                    scan_id = str(json_response.get('scan_id'))
                    time.sleep(180)
                    report = requests.get("https://www.virustotal.com/vtapi/v2/file/report", params={'apikey': key, 'resource': scan_id})
                    json_response = report.json()
                    response = int(json_response['response_code'])
                    if response == 1:
                        positives = int(json_response['positives'])
                        if positives == 0 or positives == 1:
                            label = "Benign"
                        else:
                            label = "Malicious"
                except:
                  pass

            elif response == 1:
                positives = int(json_response['positives'])
                if positives == 0 or positives == 1:
                    label = "Benign"
                else:
                    label = "Malicious"
            else:
                print(' could not be searched. Please try again later.')
            fileWrite2.write('%s:%s\n' % (hash, label))
            time.sleep(20)

    labelList = {}
    with open("label_virustotal.txt", 'r') as labelRead:
        for line in labelRead:
            key, val = line.strip().split(":")
            labelList[key] = val
    df_hash["Label_Virus"] = df_hash['SHA256'].map(labelList)
    df_hash.to_csv('static.csv', index=False)

getAVLabel()
